<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Daily DevOps</title>
  <link rel="icon" href="/static/icons/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="/static/addons.css">
</head>
<body>
  <header class="container">
    <div class="brand">
      <div class="logo">⚙️</div>
      <div>
        <h1>Daily DevOps</h1>
        <p class="subtitle">משפט היום · טיפ היום · סרטונים · כלים · הדרכות</p>
      </div>
    </div>
  </header>

  <section class="search container">
    <div class="search-box ltr">
      <input id="q" type="text" placeholder="חפש בעולם ה-DevOps (כלי, וידאו, מדריך)…">
      <select id="scope">
        <option value="local" selected>Local</option>
        <option value="web">Web</option>
        <option value="all">All</option>
      </select>
      <button id="btn">חפש</button>
    </div>
    <div id="results" class="results ltr"></div>
  </section>

  <main class="container grid">
    <!-- Quote -->
    <section class="card accent" id="quoteCard">
      <div class="section-head">
        <h2>משפט היום</h2>
        <div class="nav-wrap">
          <button class="nav-btn nav-left"  id="qPrev" aria-label="הקודם">
            <svg viewBox="0 0 24 24"><path d="M15 5l-7 7 7 7"/></svg>
          </button>
          <button class="nav-btn nav-right" id="qNext" aria-label="הבא">
            <svg viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>
      <p class="quote" id="quoteText">“{{ quote.text }}”</p>
      <div id="quoteMeta">
        {% if quote.category %}<span class="badge">{{ quote.category }}</span>{% endif %}
        {% if quote.tags %}{% for t in quote.tags %}<span class="badge">#{{ t }}</span>{% endfor %}{% endif %}
      </div>
    </section>

    <!-- Tip -->
    <section class="card" id="tipCard">
      <div class="section-head">
        <h2>טיפ DevOps של היום</h2>
        <div class="nav-wrap">
          <button class="nav-btn nav-left"  id="tPrev" aria-label="הקודם">
            <svg viewBox="0 0 24 24"><path d="M15 5l-7 7 7 7"/></svg>
          </button>
          <button class="nav-btn nav-right" id="tNext" aria-label="הבא">
            <svg viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>
      <h3 class="tip-title" id="tipTitle">{{ tip.title }}</h3>
      <p id="tipBody">{{ tip.body }}</p>
      <p class="source" id="tipSource">
        מקור: <a href="{{ tip.url }}" target="_blank" rel="noopener">{{ tip.source }}</a>
      </p>
    </section>

    <!-- Videos (single iframe with arrows) -->
    <section class="card" id="videosCard">
      <div class="section-head">
        <h2>סרטוני DevOps</h2>
        <div class="nav-wrap">
          <button class="nav-btn nav-left"  id="vPrev" aria-label="הקודם">
            <svg viewBox="0 0 24 24"><path d="M15 5l-7 7 7 7"/></svg>
          </button>
          <button class="nav-btn nav-right" id="vNext" aria-label="הבא">
            <svg viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>
      <div class="videos">
        <div class="video">
          <div class="video-title" id="vidTitle">{{ videos[0].title if videos else "" }}</div>
          <div class="video-frame" id="vidFrame">
            {% if videos %}
              <iframe id="vidIframe" src="{{ videos[0].embed }}" title="{{ videos[0].title }}" allowfullscreen></iframe>
            {% else %}
              <div class="muted">אין וידאו ברשימה.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </section>

    <!-- Tools (English/LTR) -->
    <section class="card ltr">
      <h2>כלים מומלצים</h2>
      <div class="tools">
        {% for t in tools %}
        <a class="tool" href="{{ t.url }}" target="_blank" rel="noopener">
          <div class="tool-name">{{ t.name }}</div>
          <div class="tool-desc">{{ t.desc }}</div>
        </a>
        {% endfor %}
      </div>
    </section>

    <!-- Learning (English/LTR) -->
    <section class="card ltr">
      <h2>הדרכות וקישורי לימוד</h2>
      <ul class="learning">
        {% for l in learning %}
        <li><a href="{{ l.url }}" target="_blank" rel="noopener">{{ l.title }}</a> — {{ l.desc }}</li>
        {% endfor %}
      </ul>
    </section>

    <!-- Ideas -->
    <section class="card" id="ideasCard">
      <h2>הרעיון שלכם</h2>
      <form class="idea-form" id="ideaForm">
        <input type="text" id="ideaName" placeholder="שם (לא חובה)" class="ltr">
        <textarea id="ideaText" placeholder="מה כדאי להוסיף/לשפר?"></textarea>
        <div class="idea-actions">
          <button type="submit">שלח</button>
          <span id="ideaMsg" class="muted"></span>
        </div>
      </form>
      <div class="ideas-list" id="ideasList"></div>
    </section>
  </main>

  <footer class="container footer ltr">
    <span>Deployed on Kubernetes · GitHub Actions CI/CD</span>
    <a href="https://github.com/{{ repo }}" target="_blank" rel="noopener">View on GitHub</a>
  </footer>

  <script>const VIDEOS = {{ videos | tojson | safe }};</script>

  <script>
    // Helpers
    const el = (id) => document.getElementById(id);

    // Quotes
    let quotes=[], qi=0;
    function renderQuote(){
      if(!quotes.length) return;
      const q=quotes[qi%quotes.length];
      el('quoteText').textContent='“'+(q.text||'')+'”';
      const meta=el('quoteMeta'); meta.innerHTML='';
      if(q.category){ const c=document.createElement('span'); c.className='badge'; c.textContent=q.category; meta.appendChild(c); }
      if(Array.isArray(q.tags)){ q.tags.forEach(t=>{ const s=document.createElement('span'); s.className='badge'; s.textContent='#'+t; meta.appendChild(s);});}
    }
    async function initQuotes(){
      try{
        const r=await fetch('/api/quotes'); quotes=await r.json();
        const current={{ quote|tojson|safe }}; const idx=quotes.findIndex(x=>x.text===current.text);
        qi = idx>=0?idx:0; renderQuote();
      }catch{}
    }
    el('qPrev').addEventListener('click', ()=>{ if(quotes.length){ qi=(qi-1+quotes.length)%quotes.length; renderQuote(); }});
    el('qNext').addEventListener('click', ()=>{ if(quotes.length){ qi=(qi+1)%quotes.length; renderQuote(); }});

    // Tips
    let tips=[], ti=0;
    function renderTip(){
      if(!tips.length) return;
      const t=tips[ti%tips.length];
      el('tipTitle').textContent=t.title||'';
      el('tipBody').textContent=t.body||'';
      el('tipSource').innerHTML='מקור: ' + (t.url? `<a href="${t.url}" target="_blank" rel="noopener">${t.source||'link'}</a>` : (t.source||''));
    }
    async function initTips(){
      try{
        const r=await fetch('/api/tips'); tips=await r.json();
        const current={{ tip|tojson|safe }}; const idx=tips.findIndex(x=>x.title===current.title && x.body===current.body);
        ti = idx>=0?idx:0; renderTip();
      }catch{}
    }
    el('tPrev').addEventListener('click', ()=>{ if(tips.length){ ti=(ti-1+tips.length)%tips.length; renderTip(); }});
    el('tNext').addEventListener('click', ()=>{ if(tips.length){ ti=(ti+1)%tips.length; renderTip(); }});

    // Videos
    let vi=0;
    function renderVideo(){
      if(!Array.isArray(VIDEOS)||!VIDEOS.length) return;
      const v=VIDEOS[vi%VIDEOS.length];
      el('vidTitle').textContent=v.title||'';
      const ifr=el('vidIframe'); if(ifr){ ifr.src=v.embed; ifr.title=v.title||'video'; }
    }
    el('vPrev').addEventListener('click', ()=>{ if(VIDEOS.length){ vi=(vi-1+VIDEOS.length)%VIDEOS.length; renderVideo(); }});
    el('vNext').addEventListener('click', ()=>{ if(VIDEOS.length){ vi=(vi+1)%VIDEOS.length; renderVideo(); }});

    // Search
    async function runSearch(){
      const q=el('q').value.trim(), scope=document.getElementById('scope').value, box=document.getElementById('results');
      if(!q){ box.innerHTML=''; return; }
      box.innerHTML='מחפש...';
      try{
        const r=await fetch(`/search?q=${encodeURIComponent(q)}&scope=${encodeURIComponent(scope)}&strict=true`);
        const data=await r.json();
        if(!data.results||!data.results.length){ box.innerHTML='<p>לא נמצאו תוצאות.</p>'; return; }
        box.innerHTML=data.results.map(item=>`
          <div class="result-card">
            <small class="tag">${item.type||'link'}</small>
            <a class="result-link" href="${item.url}" target="_blank" rel="noopener"><h4>${item.title||'ללא כותרת'}</h4></a>
            <p>${item.desc||''}</p>
          </div>`).join('');
      }catch{ box.innerHTML='<p>שגיאה בחיפוש.</p>'; }
    }
    document.getElementById('btn').addEventListener('click', runSearch);
    document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') runSearch(); });

    // Ideas
    async function loadIdeas(){
      try{
        const r=await fetch('/api/ideas?limit=20'); const data=await r.json();
        const list=document.getElementById('ideasList');
        list.innerHTML=(data.items||[]).map(it=>`
          <div class="idea-item">
            <div class="idea-text">${(it.text||'').replace(/</g,'&lt;')}</div>
            <div class="idea-meta muted">${it.name? it.name+' · ' : ''}${new Date(it.ts).toLocaleString('he-IL')}</div>
          </div>`).join('');
      }catch{}
    }
    document.getElementById('ideaForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const name=document.getElementById('ideaName').value.trim();
      const text=document.getElementById('ideaText').value.trim();
      const msg=document.getElementById('ideaMsg');
      if(!text){ msg.textContent='נא לכתוב רעיון...'; return; }
      msg.textContent='שולח...';
      try{
        const r=await fetch('/api/ideas',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name: name||null, text})});
        if(r.ok){ document.getElementById('ideaText').value=''; msg.textContent='תודה! הרעיון נשמר.'; loadIdeas(); }
        else{ msg.textContent='שגיאה בשליחה.'; }
      }catch{ msg.textContent='שגיאה בשליחה.'; }
    });

    // Init
    window.addEventListener('DOMContentLoaded', ()=>{
      initQuotes(); initTips(); renderVideo(); loadIdeas();
    });
  </script>
</body>
</html>
